<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dragon</title>
    <link rel="stylesheet" href="css/style.css">

    <script type="text/javascript" src="js/vendor/paper-full.js"></script>
    <script type="text/paperscript" canvas="canvas">


        var headSVG = project.importSVG(document.getElementById('drag-head'));
        headSVG.visible = true; // Turn off the effect of display:none;
        headSVG.position = new Point(0,0);
        headSVG.scale (0.3);
        headSVG.rotate(270);
        head = new Symbol(headSVG);
        head = head.place(0,0);

        var tailendSVG = project.importSVG(document.getElementById('drag-tailend'));
        tailendSVG.visible = true; // Turn off the effect of display:none;
        tailendSVG.position = new Point(0,0);
        tailendSVG.scale (0.2);
        tailendSVG.rotate(270);
        tailEnd = new Symbol(tailendSVG);
        tailEnd = tailEnd.place(0,0);


        var tailSegSVG = project.importSVG(document.getElementById('drag-seg'));
        console.log("my object: %o", tailSegSVG);
        // tailSegSVG.children[0].children[1].fillColor = 'black';
        // tailSegSVG.children[0].children[0].fillColor = 'white';

        tailSegSVG.visible = true;
        tailSegSVG.position = new Point(200, 200);
        tailSegSVG.scale(0.1);
        tailSegSVG.rotate(90);
        var tailSeg = new Symbol(tailSegSVG);



        mousePos = new Point(0, 0);
        target = new Point(0,0);

        targetHeadRot = 0;
        currentHeadRot = 0;

        var dragSegment = Base.extend({
            initialize: function(position) {
                this.position = position;
                var tailSegCopy = new Symbol(tailSegSVG);

                // Create a symbol from the path:
                var symbol = new Symbol(tailSegSVG);


                this.mySVG = symbol.place(0,0);

                this.speed = [Math.random(1.0,5.0),Math.random(1.0,5.0)];
                this.direction = [1,1];
                this.available = true;
                this.leavingContact = false;
                this.rotation = 0;

                this.basecolor = {
                    hue: 100,
                    saturation: 1,
                    brightness: 1
                };
                this.basescaling = 1.0;

                // this.mySVG.fillColor = color1;

            },
            run: function() {
                this.mySVG.position = this.position;
                this.mySVG.rotation = this.rotation;
                // this.moveAround();
            },
            move: function(position) {
                this.position = position;
            },
            move: function(position, rotate) {
                this.position = position;
                this.rotation = rotate;
            },
            resize: function(radius) {
                this.mySVG.scale(radius);
            },
            moveAround: function() {
                var xPos = this.position.x;
                var yPos = this.position.y;
                var xSize = view.viewSize.width;
                var ySize = view.viewSize.height;
                this.position.x += (this.speed[0] * this.direction[0]);
                this.position.y += (this.speed[1] * this.direction[1]);
                if(xPos > xSize){ this.direction[0] = -1;} else if(xPos < 10){ this.direction[0] = 1;}
                if(yPos > ySize){ this.direction[1] = -1;} else if(yPos < 10){ this.direction[1] = 1;}
            },
            collide: function() {

                if(this.available){
                    this.mySVG.fillColor = 'blue';
                    this.sendMessage();
                    this.changeColour('white');
                    this.scaleSegment(this.basescaling * 1.2);
                    this.available = false;
                    this.leavingContact = true;
                }

            },
            unCollide: function() {
                 if(this.leavingContact){
                //     // this.sendMessage();
                    this.mySVG.fillColor = 'blue';
                    this.available = true;
                    this.scaleSegment(this.basescaling);
                    this.leavingContact = false;
                    this.changeColour(this.basecolor);
                }


            },
            sendMessage: function() {
                // console.log("Ho Ho Ho");
            },
            changeZIndex: function() {
                // this.myCircle.
            },
            scaleSegment: function(scl) {
                this.mySVG.scaling = scl;
            },
            scaleSegmentbyInc: function(scl) {
                this.basescaling = scl;
                this.scaleSegment(this.basescaling);
            },
            changeColour: function() {
                // this.mySVG.symbol.definition.strokeColor.hue += 0.2;
                // this.mySVG.children[0].children[0].fillColor = red;
            },
            changeColour: function(color) {
                  this.mySVG.symbol.definition.children[0].children[0].fillColor = color;
            },
            changeColourbyInc: function(incre) {

                this.basecolor = {
                    hue: incre*10,
                    saturation: incre * 0.2,
                    brightness: 0.9
                };
                this.changeColour(this.basecolor);
            }

        });





        function moveDragon(incre, xin, yin) {

            var drgSgX = drgnSg[incre].position.x;
            var drgSgY = drgnSg[incre].position.y;

            var segLength = 30;
            var dx = xin - drgSgX;
            var dy = yin - drgSgY;
            var angle = Math.atan2(dy, dx);
            drgSgX = xin - Math.cos(angle) * segLength;
            drgSgY = yin - Math.sin(angle) * segLength;

            drgnSg[incre].move(new Point(drgSgX, drgSgY), angle * 180 / Math.PI);

            // tailEnd.position = drgnSg[13].position;//x, drgnSg[drgnSg.length].y);

        }


        function onMouseMove(event) {
            target = event.point;
        }


        function moveMouseBit() {
            var easing = 0.05;

            var dx = target.x - mousePos.x;
            if(Math.abs(dx) > 1) {
                mousePos.x += dx * easing;
            }

            var dy = target.y - mousePos.y;
            if(Math.abs(dy) > 1) {
                mousePos.y += dy * easing;
            }


            moveDragon(0, mousePos.x, mousePos.y);
            drgnSg[0].run();

             for (var i = 0, l = drgnSg.length-1; i < l; i++) {
                moveDragon(i+1, drgnSg[i].position.x, drgnSg[i].position.y);
                drgnSg[i+1].run();
             }

            var dx2 = drgnSg[1].position.x - drgnSg[0].position.x;
            var dy2 = drgnSg[1].position.y - drgnSg[0].position.y;

            var angle = ((Math.atan2(dy2, dx2) * 180) / Math.PI);

            targetHeadRot = angle;
            var dr = targetHeadRot - currentHeadRot;
            if(Math.abs(dr) > 1) {
                currentHeadRot += dr * 0.05;
            }

             head.position = mousePos;
             head.rotation = angle;


             var drgSegArrayLength = drgnSg.length-1;

            var dx2 = drgnSg[drgSegArrayLength].position.x - drgnSg[drgSegArrayLength-1].position.x;
            var dy2 = drgnSg[drgSegArrayLength].position.y - drgnSg[drgSegArrayLength-1].position.y;
            var angle = ((Math.atan2(dy2, dx2) * 180) / Math.PI);

             tailEnd.position = drgnSg[drgSegArrayLength].position;
             tailEnd.rotation = angle;
             // tailSeg.rotation = angle;

        }

        function map_range(value, low1, high1, low2, high2) {
            return low2 + (high2 - low2) * (value - low1) / (high1 - low1);
        }


        function dragonSegCollide(incre, vector2) {
            // var vector1 = new view.center;
            // var vector2 = new Point(drgnSg[incre].position);
            // var vecLength = vector1 - vector2;
            // var vecLengthVal = Math.abs(vecLength.length);

            // if(vecLengthVal < 50) {
            //     console.log("hey there");
            // }

            var vector1 = drgnSg[incre].position;
            var vector2 = vector2;
            // tailEnd.position = vector2;
            // view.center

            var distBool = collideTest(vector1, vector2, 50);

            if(distBool) {
                console.log(incre);
                drgnSg[incre].collide();
            } else {
                drgnSg[incre].unCollide();
            }
        }

        var collideTest = function( vector1, vector2, distance) {
            var vecLength = vector1 - vector2;
            var vecLengthVal = Math.abs(vecLength.length);

            if(vecLengthVal < distance) {
                return true;
            } else {
                return false;
            }
        }

        //--------------------- main ---------------------

        var dragonGroup = new Group();

        var drgnSg = [];
        var numSegs = 15;
        for (var i = 0; i < numSegs; i++) {
            var position = view.center;
            drgnSg.push(new dragSegment(position));
            // dragonGroup.addChild(drgnSg[i].mySVG);
            dragonGroup.addChild(drgnSg[i].mySVG);
            var scl = map_range(i,0,numSegs,1.0, 0.1);
            drgnSg[i].scaleSegmentbyInc(scl);
            drgnSg[i].changeColourbyInc(i);

        }
        dragonGroup.reverseChildren();
        dragonGroup.insertBelow(head);

        project.activeLayer.insertChild(100, head);

        var myCircle = new Path.Circle(new Point(100, 70), 20);
        myCircle.position = view.center;
        myCircle.fillColor = 'white';

        function onFrame(event) {
            moveMouseBit();

            for (var i = 0; i < numSegs; i++) {
                dragonSegCollide(i, view.center);
            }

        }



    </script>
</head>
<body>
    <canvas id="canvas" resize></canvas>
    <svg xmlns="http://www.w3.org/2000/svg"
         xmlns:xlink="http://www.w3.org/1999/xlink"
         height="600" width="600" id="drag-head" style="display:none">
        <path fill="#009BA7" d="M616.7,636.9c-4.7-24.6-21.5-40.3-51.7-40.3s-47,15.7-51.7,40.3c-4.7,24.7-8.7,131.3-8.7,131.3H565h60.4
        C625.4,768.2,621.4,661.6,616.7,636.9z"/>
        <path fill="#3A777B" d="M648.3,765.8c-43.7-56.8-47.5-119-53.9-130.8c-2.4-22-29.4-20.7-29.4-20.7s-27-1.3-29.4,20.7
        c-6.4,11.8-10.2,74-53.9,130.8c-29.4,38.2,54-4.5,83.3,65.5C594.3,761.3,677.7,804,648.3,765.8z"/>
        <circle fill="#009BA7" cx="618" cy="701.6" r="30.7"/>
        <circle cx="618" cy="701.6" r="23.7"/>
        <circle fill="#FFFFFF" cx="618" cy="701.6" r="17.2"/>
        <circle fill="#2DB9DD" cx="618" cy="701.6" r="9.9"/>
        <path fill="#3A777B" d="M587.3,701.6c0,16.9,13.7,30.7,30.7,30.7s30.7-13.7,30.7-30.7H587.3z"/>
        <circle fill="#2C595C" cx="588.4" cy="629.4" r="12.4"/>
        <circle fill="#009BA7" cx="512" cy="701.6" r="30.7"/>
        <circle cx="512" cy="701.6" r="23.7"/>
        <circle fill="#FFFFFF" cx="512" cy="701.6" r="17.2"/>
        <circle fill="#2DB9DD" cx="512" cy="701.6" r="9.9"/>
        <path fill="#3A777B" d="M542.7,701.6c0,16.9-13.7,30.7-30.7,30.7s-30.7-13.7-30.7-30.7H542.7z"/>
        <circle fill="#2C595C" cx="541.6" cy="629.4" r="12.4"/>
    </svg>

    <svg xmlns="http://www.w3.org/2000/svg"
         xmlns:xlink="http://www.w3.org/1999/xlink"
         height="600" width="600" id="drag-seg" style="display:none">
        <g>
            <path fill="#3A777B" d="M85,343c-167,95-403.5,443.4-228.8,541.2C31,982,85,1086.9,85,1086.9S139,982,313.8,884.2
                C488.5,786.4,252,438,85,343z"/>
            <path fill="#009BA7" d="M85,424c0,0-308,290.6-168.7,368.4S85,940.1,85,940.1s29.4-69.9,168.7-147.7S85,424,85,424z"/>
        </g>
    </svg>

    <svg xmlns="http://www.w3.org/2000/svg"
     xmlns:xlink="http://www.w3.org/1999/xlink"
     height="600" width="600" id="drag-tailend" style="display:none">
    <circle fill="#009BA7" cx="170" cy="561.8" r="66.5"/>
    <g>
        <path fill="#EB5D0B" d="M213.8,591.3c-3.6-32.9-43.9-29.4-43.9-29.4s-40.3-3.4-43.9,29.4c-9.6,17.6-80.8,142.4-22.9,115.5
            s31,56.8,66.9,55.3c35.9,1.5,9-82.2,66.9-55.3C294.6,733.7,223.4,609,213.8,591.3z"/>
        <path fill="#EC8141" d="M206.6,588.5c-3-27.4-36.6-24.5-36.6-24.5s-33.6-2.9-36.6,24.5c-8,14.7-67.4,118.7-19.1,96.3
            s25.8,47.3,55.7,46.1c29.9,1.2,7.5-68.5,55.7-46.1S214.5,603.2,206.6,588.5z"/>
        <path fill="#EEA476" d="M199.3,585.6c-2.4-21.9-29.3-19.7-29.3-19.7s-26.9-2.3-29.3,19.7c-6.4,11.8-53.9,95.1-15.3,77.1
            s20.7,37.9,44.6,36.9c23.9,1,6-54.9,44.6-36.9S205.7,597.4,199.3,585.6z"/>
        <path fill="#EFC8AC" d="M192,582.7c-1.8-16.5-22-14.8-22-14.8s-20.2-1.7-22,14.8c-4.8,8.8-40.5,71.4-11.5,57.9
            c29-13.5,15.5,28.5,33.5,27.7c18,0.7,4.5-41.2,33.5-27.7C232.5,654.1,196.8,591.5,192,582.7z"/>
        <path fill="#F0EBE2" d="M184.7,579.8c-1.2-11-14.7-9.9-14.7-9.9s-13.5-1.2-14.7,9.9c-3.2,5.9-27.1,47.7-7.7,38.7s10.4,19,22.4,18.5
            c12,0.5,3-27.5,22.4-18.5S187.9,585.7,184.7,579.8z"/>
    </g>
    <circle fill="#FFDD00" stroke="#EB5D0B" stroke-width="10" stroke-miterlimit="10" cx="170" cy="561.8" r="42.1"/>
    </svg>

</body>
</html>
